use crate::{
    components::{blog_card::BlogCard, header::Header},
    models::{Post, Profile},
};
use leptos::prelude::*;
use leptos_meta::*;
use rand::seq::IndexedRandom;

#[server(GetPostsAction, "/api", "GetJson")]
#[tracing::instrument]
pub async fn get_posts() -> Result<Vec<Post>, ServerFnError> {
    sqlx::query_as::<_, Post>(
        r#"SELECT 
            posts.id,
            users.name AS author_name,
            posts.author AS author,
            posts.description,
            posts.title,
            posts.slug,
            posts.markdown_content,
            posts.released,
            posts.release_date,
            posts.created_at,
            posts.updated_at
        FROM posts
        JOIN users ON posts.author = users.id
        WHERE released = true ORDER BY release_date DESC"#,
    )
    .fetch_all(crate::database::db())
    .await
    .map_err(|e| {
        let err = format!("Error while getting posts: {e:?}");
        tracing::error!("{err}");
        ServerFnError::new("Could not retrieve posts, try again later")
    })
}

#[component]
pub fn HomePage(logged_in: ReadSignal<bool>, user: ReadSignal<Option<Profile>>) -> impl IntoView {
    let blog_posts = Resource::new(|| (), |_| async { get_posts().await });
    view! {
        <Title text="Nicolas' Blog"/>

        <Header user logged_in/>
        <div class="mx-auto max-w-screen-xl px-4 pb-8 lg:pb-12 pt-8 lg:pt-12">
            <Suspense fallback=move || view! { <p>"Loading Article"</p> }>
                <ErrorBoundary fallback=|_| {
                    view! { <p class="error-messages text-xs-center">"Something went wrong, please try again later."</p>}
                }>
                    <ul class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 list-none">
                        {move || {
                            blog_posts.get().map(move |bp| {
                                bp.map(move |posts| {
                                    view! {
                                        <For
                                            each=move || posts.clone()
                                            key=|b| b.id
                                            children=move |post: Post| {
                                                let icon = get_random_icon();
                                                view! {
                                                    <li>
                                                        <BlogCard title={post.title} description={post.description} link={post.slug} date={post.release_date.unwrap_or(post.updated_at.unwrap_or(post.created_at))} icon/>
                                                    </li>
                                                }
                                            }
                                        />
                                    }
                                })
                            })
                        }}
                    </ul>
                </ErrorBoundary>

            </Suspense>

        </div>
    }
}

fn get_random_icon() -> icondata::Icon {
    let icons = vec![
        icondata::IoAccessibilityOutline,
        icondata::IoAddCircleOutline,
        icondata::IoAddOutline,
        icondata::IoAirplaneOutline,
        icondata::IoAlarmOutline,
        icondata::IoAlbumsOutline,
        icondata::IoAlertCircleOutline,
        icondata::IoAlertOutline,
        icondata::IoAmericanFootballOutline,
        icondata::IoAnalyticsOutline,
        icondata::IoApertureOutline,
        icondata::IoAppsOutline,
        icondata::IoArchiveOutline,
        icondata::IoArrowBackCircleOutline,
        icondata::IoArrowBackOutline,
        icondata::IoArrowDownCircleOutline,
        icondata::IoArrowDownOutline,
        icondata::IoArrowForwardCircleOutline,
        icondata::IoArrowForwardOutline,
        icondata::IoArrowRedoCircleOutline,
        icondata::IoArrowRedoOutline,
        icondata::IoArrowUndoCircleOutline,
        icondata::IoArrowUndoOutline,
        icondata::IoArrowUpCircleOutline,
        icondata::IoArrowUpOutline,
        icondata::IoAtCircleOutline,
        icondata::IoAtOutline,
        icondata::IoAttachOutline,
        icondata::IoBackspaceOutline,
        icondata::IoBagAddOutline,
        icondata::IoBagCheckOutline,
        icondata::IoBagHandleOutline,
        icondata::IoBagOutline,
        icondata::IoBagRemoveOutline,
        icondata::IoBalloonOutline,
        icondata::IoBanOutline,
        icondata::IoBandageOutline,
        icondata::IoBarChartOutline,
        icondata::IoBarbellOutline,
        icondata::IoBarcodeOutline,
        icondata::IoBaseballOutline,
        icondata::IoBasketOutline,
        icondata::IoBasketballOutline,
        icondata::IoBatteryChargingOutline,
        icondata::IoBatteryDeadOutline,
        icondata::IoBatteryFullOutline,
        icondata::IoBatteryHalfOutline,
        icondata::IoBeakerOutline,
        icondata::IoBedOutline,
        icondata::IoBeerOutline,
        icondata::IoBicycleOutline,
        icondata::IoBluetoothOutline,
        icondata::IoBoatOutline,
        icondata::IoBodyOutline,
        icondata::IoBonfireOutline,
        icondata::IoBookOutline,
        icondata::IoBookmarkOutline,
        icondata::IoBookmarksOutline,
        icondata::IoBowlingBallOutline,
        icondata::IoBriefcaseOutline,
        icondata::IoBrowsersOutline,
        icondata::IoBrushOutline,
        icondata::IoBugOutline,
        icondata::IoBuildOutline,
        icondata::IoBulbOutline,
        icondata::IoBusOutline,
        icondata::IoBusinessOutline,
        icondata::IoCafeOutline,
        icondata::IoCalculatorOutline,
        icondata::IoCalendarClearOutline,
        icondata::IoCalendarNumberOutline,
        icondata::IoCalendarOutline,
        icondata::IoCallOutline,
        icondata::IoCameraOutline,
        icondata::IoCameraReverseOutline,
        icondata::IoCarOutline,
        icondata::IoCarSportOutline,
        icondata::IoCardOutline,
        icondata::IoCaretBackCircleOutline,
        icondata::IoCaretBackOutline,
        icondata::IoCaretDownCircleOutline,
        icondata::IoCaretDownOutline,
        icondata::IoCaretForwardCircleOutline,
        icondata::IoCaretForwardOutline,
        icondata::IoCaretUpCircleOutline,
        icondata::IoCaretUpOutline,
        icondata::IoCartOutline,
        icondata::IoCashOutline,
        icondata::IoCellularOutline,
        icondata::IoChatboxEllipsesOutline,
        icondata::IoChatboxOutline,
        icondata::IoChatbubbleEllipsesOutline,
        icondata::IoChatbubbleOutline,
        icondata::IoChatbubblesOutline,
        icondata::IoCheckboxOutline,
        icondata::IoCheckmarkCircleOutline,
        icondata::IoCheckmarkDoneCircleOutline,
        icondata::IoCheckmarkDoneOutline,
        icondata::IoCheckmarkOutline,
        icondata::IoChevronBackCircleOutline,
        icondata::IoChevronBackOutline,
        icondata::IoChevronCollapseOutline,
        icondata::IoChevronDownCircleOutline,
        icondata::IoChevronDownOutline,
        icondata::IoChevronExpandOutline,
        icondata::IoChevronForwardCircleOutline,
        icondata::IoChevronForwardOutline,
        icondata::IoChevronUpCircleOutline,
        icondata::IoChevronUpOutline,
        icondata::IoClipboardOutline,
        icondata::IoCloseCircleOutline,
        icondata::IoCloseOutline,
        icondata::IoCloudCircleOutline,
        icondata::IoCloudDoneOutline,
        icondata::IoCloudDownloadOutline,
        icondata::IoCloudOfflineOutline,
        icondata::IoCloudOutline,
        icondata::IoCloudUploadOutline,
        icondata::IoCloudyNightOutline,
        icondata::IoCloudyOutline,
        icondata::IoCodeDownloadOutline,
        icondata::IoCodeOutline,
        icondata::IoCodeSlashOutline,
        icondata::IoCodeWorkingOutline,
        icondata::IoCogOutline,
        icondata::IoColorFillOutline,
        icondata::IoColorFilterOutline,
        icondata::IoColorPaletteOutline,
        icondata::IoColorWandOutline,
        icondata::IoCompassOutline,
        icondata::IoConstructOutline,
        icondata::IoContractOutline,
        icondata::IoContrastOutline,
        icondata::IoCopyOutline,
        icondata::IoCreateOutline,
        icondata::IoCropOutline,
        icondata::IoCubeOutline,
        icondata::IoCutOutline,
        icondata::IoDesktopOutline,
        icondata::IoDiamondOutline,
        icondata::IoDiceOutline,
        icondata::IoDiscOutline,
        icondata::IoDocumentAttachOutline,
        icondata::IoDocumentLockOutline,
        icondata::IoDocumentOutline,
        icondata::IoDocumentTextOutline,
        icondata::IoDocumentsOutline,
        icondata::IoDownloadOutline,
        icondata::IoDuplicateOutline,
        icondata::IoEarOutline,
        icondata::IoEarthOutline,
        icondata::IoEaselOutline,
        icondata::IoEggOutline,
        icondata::IoEllipseOutline,
        icondata::IoEllipsisHorizontalCircleOutline,
        icondata::IoEllipsisHorizontalOutline,
        icondata::IoEllipsisVerticalCircleOutline,
        icondata::IoEllipsisVerticalOutline,
        icondata::IoEnterOutline,
        icondata::IoExitOutline,
        icondata::IoExpandOutline,
        icondata::IoExtensionPuzzleOutline,
        icondata::IoEyeOffOutline,
        icondata::IoEyeOutline,
        icondata::IoEyedropOutline,
        icondata::IoFastFoodOutline,
        icondata::IoFemaleOutline,
        icondata::IoFileTrayFullOutline,
        icondata::IoFileTrayOutline,
        icondata::IoFileTrayStackedOutline,
        icondata::IoFilmOutline,
        icondata::IoFilterCircleOutline,
        icondata::IoFilterOutline,
        icondata::IoFingerPrintOutline,
        icondata::IoFishOutline,
        icondata::IoFitnessOutline,
        icondata::IoFlagOutline,
        icondata::IoFlameOutline,
        icondata::IoFlashOffOutline,
        icondata::IoFlashOutline,
        icondata::IoFlashlightOutline,
        icondata::IoFlaskOutline,
        icondata::IoFlowerOutline,
        icondata::IoFolderOpenOutline,
        icondata::IoFolderOutline,
        icondata::IoFootballOutline,
        icondata::IoFootstepsOutline,
        icondata::IoFunnelOutline,
        icondata::IoGameControllerOutline,
        icondata::IoGiftOutline,
        icondata::IoGitBranchOutline,
        icondata::IoGitCommitOutline,
        icondata::IoGitCompareOutline,
        icondata::IoGitMergeOutline,
        icondata::IoGitNetworkOutline,
        icondata::IoGitPullRequestOutline,
        icondata::IoGlassesOutline,
        icondata::IoGlobeOutline,
        icondata::IoGolfOutline,
        icondata::IoGridOutline,
        icondata::IoHammerOutline,
        icondata::IoHandLeftOutline,
        icondata::IoHandRightOutline,
        icondata::IoHappyOutline,
        icondata::IoHardwareChipOutline,
        icondata::IoHeadsetOutline,
        icondata::IoHeartCircleOutline,
        icondata::IoHeartDislikeCircleOutline,
        icondata::IoHeartDislikeOutline,
        icondata::IoHeartHalfOutline,
        icondata::IoHeartOutline,
        icondata::IoHelpBuoyOutline,
        icondata::IoHelpCircleOutline,
        icondata::IoHelpOutline,
        icondata::IoHomeOutline,
        icondata::IoHourglassOutline,
        icondata::IoIceCreamOutline,
        icondata::IoIdCardOutline,
        icondata::IoImageOutline,
        icondata::IoImagesOutline,
        icondata::IoInfiniteOutline,
        icondata::IoInformationCircleOutline,
        icondata::IoInformationOutline,
        icondata::IoInvertModeOutline,
        icondata::IoJournalOutline,
        icondata::IoKeyOutline,
        icondata::IoKeypadOutline,
        icondata::IoLanguageOutline,
        icondata::IoLaptopOutline,
        icondata::IoLayersOutline,
        icondata::IoLeafOutline,
        icondata::IoLibraryOutline,
        icondata::IoLinkOutline,
        icondata::IoListCircleOutline,
        icondata::IoListOutline,
        icondata::IoLocateOutline,
        icondata::IoLocationOutline,
        icondata::IoLockClosedOutline,
        icondata::IoLockOpenOutline,
        icondata::IoLogInOutline,
        icondata::IoLogOutOutline,
        icondata::IoMagnetOutline,
        icondata::IoMailOpenOutline,
        icondata::IoMailOutline,
        icondata::IoMailUnreadOutline,
        icondata::IoMaleFemaleOutline,
        icondata::IoMaleOutline,
        icondata::IoManOutline,
        icondata::IoMapOutline,
        icondata::IoMedalOutline,
        icondata::IoMedicalOutline,
        icondata::IoMedkitOutline,
        icondata::IoMegaphoneOutline,
        icondata::IoMenuOutline,
        icondata::IoMicCircleOutline,
        icondata::IoMicOffCircleOutline,
        icondata::IoMicOffOutline,
        icondata::IoMicOutline,
        icondata::IoMoonOutline,
        icondata::IoMoveOutline,
        icondata::IoMusicalNoteOutline,
        icondata::IoMusicalNotesOutline,
        icondata::IoNavigateCircleOutline,
        icondata::IoNavigateOutline,
        icondata::IoNewspaperOutline,
        icondata::IoNotificationsCircleOutline,
        icondata::IoNotificationsOffCircleOutline,
        icondata::IoNotificationsOffOutline,
        icondata::IoNotificationsOutline,
        icondata::IoNuclearOutline,
        icondata::IoNutritionOutline,
        icondata::IoOpenOutline,
        icondata::IoOptionsOutline,
        icondata::IoPaperPlaneOutline,
        icondata::IoPartlySunnyOutline,
        icondata::IoPauseCircleOutline,
        icondata::IoPauseOutline,
        icondata::IoPawOutline,
        icondata::IoPencilOutline,
        icondata::IoPeopleCircleOutline,
        icondata::IoPeopleOutline,
        icondata::IoPersonAddOutline,
        icondata::IoPersonCircleOutline,
        icondata::IoPersonOutline,
        icondata::IoPersonRemoveOutline,
        icondata::IoPhoneLandscapeOutline,
        icondata::IoPhonePortraitOutline,
        icondata::IoPieChartOutline,
        icondata::IoPinOutline,
        icondata::IoPintOutline,
        icondata::IoPizzaOutline,
        icondata::IoPlanetOutline,
        icondata::IoPlayBackCircleOutline,
        icondata::IoPlayBackOutline,
        icondata::IoPlayCircleOutline,
        icondata::IoPlayForwardCircleOutline,
        icondata::IoPlayForwardOutline,
        icondata::IoPlayOutline,
        icondata::IoPlaySkipBackCircleOutline,
        icondata::IoPlaySkipBackOutline,
        icondata::IoPlaySkipForwardCircleOutline,
        icondata::IoPlaySkipForwardOutline,
        icondata::IoPodiumOutline,
        icondata::IoPowerOutline,
        icondata::IoPricetagOutline,
        icondata::IoPricetagsOutline,
        icondata::IoPrintOutline,
        icondata::IoPrismOutline,
        icondata::IoPulseOutline,
        icondata::IoPushOutline,
        icondata::IoQrCodeOutline,
        icondata::IoRadioButtonOffOutline,
        icondata::IoRadioButtonOnOutline,
        icondata::IoRadioOutline,
        icondata::IoRainyOutline,
        icondata::IoReaderOutline,
        icondata::IoReceiptOutline,
        icondata::IoRecordingOutline,
        icondata::IoRefreshCircleOutline,
        icondata::IoRefreshOutline,
        icondata::IoReloadCircleOutline,
        icondata::IoReloadOutline,
        icondata::IoRemoveCircleOutline,
        icondata::IoRemoveOutline,
        icondata::IoReorderFourOutline,
        icondata::IoReorderThreeOutline,
        icondata::IoReorderTwoOutline,
        icondata::IoRepeatOutline,
        icondata::IoResizeOutline,
        icondata::IoRestaurantOutline,
        icondata::IoReturnDownBackOutline,
        icondata::IoReturnDownForwardOutline,
        icondata::IoReturnUpBackOutline,
        icondata::IoReturnUpForwardOutline,
        icondata::IoRibbonOutline,
        icondata::IoRocketOutline,
        icondata::IoRoseOutline,
        icondata::IoSadOutline,
        icondata::IoSaveOutline,
        icondata::IoScaleOutline,
        icondata::IoScanCircleOutline,
        icondata::IoScanOutline,
        icondata::IoSchoolOutline,
        icondata::IoSearchCircleOutline,
        icondata::IoSearchOutline,
        icondata::IoSendOutline,
        icondata::IoServerOutline,
        icondata::IoSettingsOutline,
        icondata::IoShapesOutline,
        icondata::IoShareOutline,
        icondata::IoShareSocialOutline,
        icondata::IoShieldCheckmarkOutline,
        icondata::IoShieldHalfOutline,
        icondata::IoShieldOutline,
        icondata::IoShirtOutline,
        icondata::IoShuffleOutline,
        icondata::IoSkullOutline,
        icondata::IoSnowOutline,
        icondata::IoSparklesOutline,
        icondata::IoSpeedometerOutline,
        icondata::IoSquareOutline,
        icondata::IoStarHalfOutline,
        icondata::IoStarOutline,
        icondata::IoStatsChartOutline,
        icondata::IoStopCircleOutline,
        icondata::IoStopOutline,
        icondata::IoStopwatchOutline,
        icondata::IoStorefrontOutline,
        icondata::IoSubwayOutline,
        icondata::IoSunnyOutline,
        icondata::IoSwapHorizontalOutline,
        icondata::IoSwapVerticalOutline,
        icondata::IoSyncCircleOutline,
        icondata::IoSyncOutline,
        icondata::IoTabletLandscapeOutline,
        icondata::IoTabletPortraitOutline,
        icondata::IoTelescopeOutline,
        icondata::IoTennisballOutline,
        icondata::IoTerminalOutline,
        icondata::IoTextOutline,
        icondata::IoThermometerOutline,
        icondata::IoThumbsDownOutline,
        icondata::IoThumbsUpOutline,
        icondata::IoThunderstormOutline,
        icondata::IoTicketOutline,
        icondata::IoTimeOutline,
        icondata::IoTimerOutline,
        icondata::IoTodayOutline,
        icondata::IoToggleOutline,
        icondata::IoTrailSignOutline,
        icondata::IoTrainOutline,
        icondata::IoTransgenderOutline,
        icondata::IoTrashBinOutline,
        icondata::IoTrashOutline,
        icondata::IoTrendingDownOutline,
        icondata::IoTrendingUpOutline,
        icondata::IoTriangleOutline,
        icondata::IoTrophyOutline,
        icondata::IoTvOutline,
        icondata::IoUmbrellaOutline,
        icondata::IoUnlinkOutline,
        icondata::IoVideocamOffOutline,
        icondata::IoVideocamOutline,
        icondata::IoVolumeHighOutline,
        icondata::IoVolumeLowOutline,
        icondata::IoVolumeMediumOutline,
        icondata::IoVolumeMuteOutline,
        icondata::IoVolumeOffOutline,
        icondata::IoWalkOutline,
        icondata::IoWalletOutline,
        icondata::IoWarningOutline,
        icondata::IoWatchOutline,
        icondata::IoWaterOutline,
        icondata::IoWifiOutline,
        icondata::IoWineOutline,
        icondata::IoWomanOutline,
    ];
    icons.choose(&mut rand::rng()).unwrap()
}
